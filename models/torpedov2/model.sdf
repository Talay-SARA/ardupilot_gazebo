<?xml version="1.0" ?>
<sdf version="1.9">
  <model name="torpedov2">

    <!-- ==================== BODY ==================== -->

    <link name="base_link">
      <inertial>
        <mass>147.8671</mass>
        <inertia>
          <ixx>3.000000</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>41.980233</iyy>
          <iyz>0</iyz>
          <izz>41.980233</izz>
        </inertia>
      </inertial>

      <collision name="main_body_buoyancy">
        <geometry>
          <box>
            <size>2 0.3 0.246445166667</size>
          </box>
        </geometry>
      </collision>

      <visual name="body_visual">
        <geometry>
          <mesh>
            <uri>meshes/tethys.dae</uri>
            <submesh>
              <name>Body</name>
              <center>false</center>
            </submesh>
          </mesh>
        </geometry>
        <material>
          <diffuse>1.0 1.0 1.0</diffuse>
          <specular>1.0 1.0 1.0</specular>
          <pbr>
            <metal>
              <albedo_map>materials/textures/Tethys_Albedo.png</albedo_map>
              <normal_map>materials/textures/Tethys_Normal.png</normal_map>
              <metalness_map>materials/textures/Tethys_Metalness.png</metalness_map>
              <roughness_map>materials/textures/Tethys_Roughness.png</roughness_map>
            </metal>
          </pbr>
        </material>
      </visual>

      <!-- IMU sensor (required for ArduPilot) -->
      <sensor name="imu_sensor" type="imu">
        <always_on>1</always_on>
        <update_rate>1000</update_rate>
      </sensor>
    </link>

    <!-- ==================== HORIZONTAL FINS (elevator / pitch) ==================== -->

    <link name="horizontal_fins">
      <pose>1.05 0 0 0 0 0</pose>
      <inertial>
        <mass>0.2</mass>
        <inertia>
          <ixx>0.0007924568755</ixx>
          <ixy>-0.0000000002674</ixy>
          <ixz>0.0003978158176</ixz>
          <iyy>0.0010546736475</iyy>
          <iyz>-0.0000000006729</iyz>
          <izz>0.0002633558262</izz>
        </inertia>
      </inertial>
      <collision name="collision">
        <geometry>
          <box>
            <size>0.1 0.1 0.02</size>
          </box>
        </geometry>
      </collision>
      <visual name="visual">
        <pose>-1.05 0 0 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>meshes/tethys.dae</uri>
            <submesh>
              <name>Fins_Horizontal</name>
              <center>false</center>
            </submesh>
          </mesh>
        </geometry>
        <material>
          <diffuse>1.0 1.0 1.0</diffuse>
          <specular>1.0 1.0 1.0</specular>
          <pbr>
            <metal>
              <albedo_map>materials/textures/Tethys_Albedo.png</albedo_map>
              <normal_map>materials/textures/Tethys_Normal.png</normal_map>
              <metalness_map>materials/textures/Tethys_Metalness.png</metalness_map>
              <roughness_map>materials/textures/Tethys_Roughness.png</roughness_map>
            </metal>
          </pbr>
        </material>
      </visual>
    </link>

    <!-- ==================== VERTICAL FINS (rudder / yaw) ==================== -->

    <link name="vertical_fins">
      <pose>1.05 0 0 0 0 0</pose>
      <inertial>
        <mass>0.2</mass>
        <inertia>
          <ixx>0.0007924568755</ixx>
          <ixy>-0.0000000002674</ixy>
          <ixz>0.0003978158176</ixz>
          <iyy>0.0010546736475</iyy>
          <iyz>-0.0000000006729</iyz>
          <izz>0.0002633558262</izz>
        </inertia>
      </inertial>
      <collision name="collision">
        <geometry>
          <box>
            <size>0.1 0.1 0.02</size>
          </box>
        </geometry>
      </collision>
      <visual name="visual">
        <pose>-1.05 0 0 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>meshes/tethys.dae</uri>
            <submesh>
              <name>Fins_vertical</name>
              <center>false</center>
            </submesh>
          </mesh>
        </geometry>
        <material>
          <diffuse>1.0 1.0 1.0</diffuse>
          <specular>1.0 1.0 1.0</specular>
          <pbr>
            <metal>
              <albedo_map>materials/textures/Tethys_Albedo.png</albedo_map>
              <normal_map>materials/textures/Tethys_Normal.png</normal_map>
              <metalness_map>materials/textures/Tethys_Metalness.png</metalness_map>
              <roughness_map>materials/textures/Tethys_Roughness.png</roughness_map>
            </metal>
          </pbr>
        </material>
      </visual>
    </link>

    <!-- ==================== PROPELLER ==================== -->

    <link name="propeller">
      <pose>1.43162 0 0 0 0 0</pose>
      <inertial>
        <mass>0.09</mass>
        <inertia>
          <ixx>0.000143971303</ixx>
          <ixy>0.000000000008</ixy>
          <ixz>-0.000000000224</ixz>
          <iyy>0.000140915448</iyy>
          <iyz>-0.000025236433</iyz>
          <izz>0.000033571862</izz>
        </inertia>
      </inertial>
      <collision name="collision">
        <geometry>
          <box>
            <size>0.03 0.1 0.03</size>
          </box>
        </geometry>
      </collision>
      <visual name="visual">
        <pose>-1.43162 0 0 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>meshes/tethys.dae</uri>
            <submesh>
              <name>Prop</name>
              <center>false</center>
            </submesh>
          </mesh>
        </geometry>
        <material>
          <diffuse>1.0 1.0 1.0</diffuse>
          <specular>1.0 1.0 1.0</specular>
          <pbr>
            <metal>
              <albedo_map>materials/textures/Tethys_Albedo.png</albedo_map>
              <normal_map>materials/textures/Tethys_Normal.png</normal_map>
              <metalness_map>materials/textures/Tethys_Metalness.png</metalness_map>
              <roughness_map>materials/textures/Tethys_Roughness.png</roughness_map>
            </metal>
          </pbr>
        </material>
      </visual>
    </link>

    <!-- ==================== JOINTS ==================== -->

    <joint name="horizontal_fins_joint" type="revolute">
      <parent>base_link</parent>
      <child>horizontal_fins</child>
      <axis>
        <xyz>0 1 0</xyz>
        <limit>
          <lower>-0.5236</lower>
          <upper>0.5236</upper>
          <effort>-1</effort>
          <velocity>-1</velocity>
        </limit>
        <dynamics>
          <damping>0.2</damping>
          <friction>0.02</friction>
        </dynamics>
      </axis>
    </joint>

    <joint name="vertical_fins_joint" type="revolute">
      <parent>base_link</parent>
      <child>vertical_fins</child>
      <axis>
        <xyz>0 0 1</xyz>
        <limit>
          <lower>-0.5236</lower>
          <upper>0.5236</upper>
          <effort>-1</effort>
          <velocity>-1</velocity>
        </limit>
        <dynamics>
          <damping>0.1</damping>
          <friction>0.01</friction>
        </dynamics>
      </axis>
    </joint>

    <joint name="propeller_joint" type="revolute">
      <parent>base_link</parent>
      <child>propeller</child>
      <axis>
        <xyz>1 0 0</xyz>
        <limit>
          <lower>-1e+12</lower>
          <upper>1e+12</upper>
          <effort>-1</effort>
          <velocity>-1</velocity>
        </limit>
      </axis>
    </joint>

    <!-- ==================== HYDRODYNAMICS ==================== -->

    <plugin
      filename="gz-sim-hydrodynamics-system"
      name="gz::sim::systems::Hydrodynamics">
      <link_name>base_link</link_name>
      <xDotU>-4.876161</xDotU>
      <yDotV>-126.324739</yDotV>
      <zDotW>-126.324739</zDotW>
      <kDotP>0</kDotP>
      <mDotQ>-33.46</mDotQ>
      <nDotR>-33.46</nDotR>
      <xUabsU>-6.2282</xUabsU>
      <xU>0</xU>
      <yVabsV>-601.27</yVabsV>
      <yV>0</yV>
      <zWabsW>-601.27</zWabsW>
      <zW>0</zW>
      <kPabsP>-0.1916</kPabsP>
      <kP>0</kP>
      <mQabsQ>-632.698957</mQabsQ>
      <mQ>0</mQ>
      <nRabsR>-632.698957</nRabsR>
      <nR>0</nR>
    </plugin>

    <!-- ==================== LIFT AND DRAG ==================== -->

    <!-- Vertical fin (rudder - yaw control) -->
    <plugin
      filename="gz-sim-lift-drag-system"
      name="gz::sim::systems::LiftDrag">
      <air_density>1000</air_density>
      <cla>4.13</cla>
      <cla_stall>-1.1</cla_stall>
      <cda>0.2</cda>
      <cda_stall>0.03</cda_stall>
      <alpha_stall>0.17</alpha_stall>
      <a0>0</a0>
      <area>0.0244</area>
      <upward>0 1 0</upward>
      <forward>1 0 0</forward>
      <link_name>vertical_fins</link_name>
      <cp>0 0 0</cp>
    </plugin>

    <!-- Horizontal fin (elevator - pitch control) -->
    <plugin
      filename="gz-sim-lift-drag-system"
      name="gz::sim::systems::LiftDrag">
      <air_density>1000</air_density>
      <cla>4.13</cla>
      <cla_stall>-1.1</cla_stall>
      <cda>0.2</cda>
      <cda_stall>0.03</cda_stall>
      <alpha_stall>0.17</alpha_stall>
      <a0>0</a0>
      <area>0.0244</area>
      <upward>0 0 1</upward>
      <forward>1 0 0</forward>
      <link_name>horizontal_fins</link_name>
      <cp>0 0 0</cp>
    </plugin>

    <!-- ==================== THRUSTER ==================== -->

    <plugin
      filename="gz-sim-thruster-system"
      name="gz::sim::systems::Thruster">
      <namespace>torpedov2</namespace>
      <joint_name>propeller_joint</joint_name>
      <thrust_coefficient>0.004422</thrust_coefficient>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>0.2</propeller_diameter>
    </plugin>

    <!-- ==================== JOINT STATE + FORCE ==================== -->

    <plugin
      filename="gz-sim-joint-state-publisher-system"
      name="gz::sim::systems::JointStatePublisher">
      <joint_name>vertical_fins_joint</joint_name>
      <joint_name>horizontal_fins_joint</joint_name>
      <joint_name>propeller_joint</joint_name>
    </plugin>

    <plugin
      filename="gz-sim-apply-joint-force-system"
      name="gz::sim::systems::ApplyJointForce">
      <joint_name>vertical_fins_joint</joint_name>
    </plugin>
    <plugin
      filename="gz-sim-apply-joint-force-system"
      name="gz::sim::systems::ApplyJointForce">
      <joint_name>horizontal_fins_joint</joint_name>
    </plugin>

    <!-- ==================== ARDUPILOT PLUGIN ==================== -->

    <plugin name="ArduPilotPlugin" filename="ArduPilotPlugin">
      <!-- Port settings -->
      <fdm_addr>127.0.0.1</fdm_addr>
      <fdm_port_in>9002</fdm_port_in>
      <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>
      <lock_step>1</lock_step>

      <!-- Frame conventions
           Tethys body: x-forward, y-left, z-up
           modelXYZToAirplaneXForwardZDown: body to NED body frame
           gazeboXYZToNED: world to NED world frame
      -->
      <modelXYZToAirplaneXForwardZDown degrees="true">0 0 0 180 0 180</modelXYZToAirplaneXForwardZDown>
      <gazeboXYZToNED degrees="true">0 0 0 180 0 90</gazeboXYZToNED>

      <!-- Sensors -->
      <imuName>base_link::imu_sensor</imuName>

      <!--
          SERVO1 (channel 0) - Thruster
          Uses COMMAND type to publish thrust to the Thruster plugin topic.
          PWM [1100, 1900] => raw [0, 1], offset -0.5 => [-0.5, 0.5]
          multiplier -100 => thrust [-50, 50] N (negative = forward)
      -->
      <control channel="0">
        <jointName>propeller_joint</jointName>
        <useForce>0</useForce>
        <multiplier>-100</multiplier>
        <offset>-0.5</offset>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/torpedov2/joint/propeller_joint/cmd_thrust</cmd_topic>
      </control>

      <!--
          SERVO2 (channel 1) - Vertical fins (rudder / yaw)
          PWM [1100, 1900] => raw [0, 1], offset -0.5 => [-0.5, 0.5]
          multiplier 1.048 => position [-0.524, 0.524] rad (~30 deg)
      -->
      <control channel="1">
        <jointName>vertical_fins_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.048</multiplier>
        <offset>-0.5</offset>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>POSITION</type>
        <p_gain>10.0</p_gain>
        <i_gain>0</i_gain>
        <d_gain>0.5</d_gain>
        <i_max>1</i_max>
        <i_min>-1</i_min>
        <cmd_max>10.0</cmd_max>
        <cmd_min>-10.0</cmd_min>
      </control>

      <!--
          SERVO3 (channel 2) - Horizontal fins (elevator / pitch)
          PWM [1100, 1900] => raw [0, 1], offset -0.5 => [-0.5, 0.5]
          multiplier 1.048 => position [-0.524, 0.524] rad (~30 deg)
      -->
      <control channel="2">
        <jointName>horizontal_fins_joint</jointName>
        <useForce>1</useForce>
        <multiplier>1.048</multiplier>
        <offset>-0.5</offset>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>POSITION</type>
        <p_gain>5.0</p_gain>
        <i_gain>0</i_gain>
        <d_gain>1.0</d_gain>
        <i_max>1</i_max>
        <i_min>-1</i_min>
        <cmd_max>10.0</cmd_max>
        <cmd_min>-10.0</cmd_min>
      </control>
    </plugin>

  </model>
</sdf>
